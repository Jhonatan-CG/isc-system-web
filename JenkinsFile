pipeline {
    agent any
    tools {
        nodejs '20'
    }
    stages {
        stage('Clone Project') {
            steps {
                script {
                    echo 'Cloning the project repository...'
                }
                git branch: 'qa', url: 'https://github.com/Jhonatan-CG/isc-system-web.git'
            }
        }
        stage('Install Dependencies') {
            steps {
                script {
                    echo 'Installing global dependencies with Yarn...'
                }
                sh 'npm install -g yarn'
                script {
                    echo 'Installing project dependencies with Yarn...'
                }
                sh 'yarn install'
            }
        }
        stage('Install Cypress') {
            steps {
                script {
                    echo 'Adding Cypress as a dev dependency...'
                }
                sh 'yarn add cypress --dev'
            }
        }
        stage('Install Xvfb and Dependencies') {
            steps {
                script {
                    echo 'Installing Xvfb and necessary dependencies...'
                }
                sh '''
                    apt-get update
                    apt-get install -y xvfb libgtk2.0-0 libgtk-3-0 libgbm-dev \
                    libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 \
                    libxtst6 libx11-xcb1
                '''
            }
        }
        stage('Run e2e Tests') {
            steps {
                script {
                    echo 'Running end-to-end tests with Cypress...'
                }
                sh 'xvfb-run --auto-servernum -- npx cypress run'
            }
        }
    }
    post {
        always {
            script {
                echo 'Cleaning up workspace...'
            }
            cleanWs()
        }
    }
}
